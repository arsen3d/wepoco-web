<!DOCTYPE html>
<!-- 
    Test of interactive access to data in Fusion Tables with map and graph.
    Michael Saunby. November 2011
    http://mike.saunby.net
    Source code for this, and similar projects at -
    http://code.google.com/p/wepoco-web/
-->
<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <title>Fusion Tables CLIMAT Demo</title>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript">
      google.load('visualization', '1', {packages: ['linechart']});
  </script>
  <script type="text/javascript">

  // Id numbers of Google Fusion Tables (all public) containing CLIMAT data.
  var tableIds = {"2010":"2155155","2009":"2196403","2008":"2196338","2007":"2196340",
  "2006":"2196342","2005":"2196347","2004":"2196349","2003":"2196352","2002":"2196295",
  "2001":"2196296","2000":"2196299"};

  var visualization1;
  var visualization2;
  var map;
  var yr;
  var parameter = "MeanT";
  var reanParam = "ncep_air_2m_mon_mean";
  var layer;
  var listener;
  var infowin;
  var latLng;

  function setYr() {
    yr = document.getElementById('year').value;
    drawMap();
  }

  function setParam() {
    parameter = document.getElementById('param').value;
  }
  
  function setRean() {
    reanParam = document.getElementById('rean').value;
  }

  function drawMap(){
    var tableId = tableIds[yr];
    if(layer){layer.setMap(null);}
    // Note.  Could use the supplied FusionTables InfoWindow but here
    // I choose not to, as it has too much information and only relates
    // to first month of data, as this is what the map will show.
    // Instead create my own InfoWindow for each click. 
    layer = new google.maps.FusionTablesLayer(Number(tableId),{
      query:"select 'LatLng' from " + tableId + " WHERE Date='"+yr+"/01/01'",
      suppressInfoWindows:true});
    layer.setMap(map);
    google.maps.event.addListener(layer, 'click', function(arg) {
      try{infowin.close();}catch(err){}
      infowin = new google.maps.InfoWindow(
       {content:"<div><b>"+arg.row['IndexNbr'].value+"</b><br>"+arg.row['LatLng'].value+"</div>",
        position:arg.latLng});
      infowin.open(map);
      drawVisualization(arg.row['IndexNbr'].value, tableId);
      latLng = arg.row['LatLng'].value.split(',');
      draw20crVis(latLng, yr);
    });
    console.log(listener);
  }

  function initialize() {
    var my_centre = new google.maps.LatLng(0,0);
    map = new google.maps.Map(document.getElementById('map_canvas'), {
      center: my_centre, zoom: 2,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    // Calling setYr will also draw the map.
    setYr();
  }

  function drawVisualization(indexNbr, tableId) {
      var  queryText = encodeURIComponent("SELECT Date,"+parameter+" FROM " + tableId +" WHERE IndexNbr="+indexNbr);
      var query = new google.visualization.Query("http://www.google.com/fusiontables/gvizdata?tq="  + queryText); 
      // Send the query with a callback function.
      document.getElementById('visualization').innerHTML = "Loading " + parameter + " for station "+indexNbr+"...";
      query.send(handleQueryResponse);
  }

  function draw20crVis(latlng, yr) {
      var queryUri = "http://saunby.net/cgi-bin/py/gviz20cr.py?lat="+latlng[0]+"&lng="+latlng[1]+"&q="+reanParam+"&yr0=2000";
      var query =  new google.visualization.Query(queryUri);
      document.getElementById('visualization2').innerHTML = queryUri;
      query.send(handleQueryResponse20cr);
  }

  function handleQueryResponse(response) {
      if (response.isError()) {
        alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
        return;
      }
      visualization1 = new google.visualization.LineChart(document.getElementById('visualization'));
      visualization1.draw(response.getDataTable(), {legend: 'bottom'});
  }

  function handleQueryResponse20cr(response) {
      if (response.isError()) {
        alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
        return;
      }
      visualization2 = new google.visualization.LineChart(document.getElementById('visualization2'));
      visualization2.draw(response.getDataTable(), {legend: 'bottom'});
  }

  </script>
</head>
<body onload="initialize()">
<div style="width:100%">
 <select id="year" onchange="javascript:setYr()">
    <option value="2000">2000</option>
    <option value="2001">2001</option>
    <option value="2002">2002</option>
    <option value="2003">2003</option>
    <option value="2004">2004</option>
    <option value="2005">2005</option>
    <option value="2006">2006</option>
    <option value="2007">2007</option>
    <option value="2008">2008</option>
    <option value="2009">2009</option>
     <option value="2010" selected>2010</option>
    </select>
  CLIMAT data
  <select id="param" onchange="javascript:setParam()">
        <option value="RainR">rainfall</option>
        <option value="MeanT" selected>temperature</option>
        <option value="SunHrs">sunshine</option>
        <option value="MSLP">pressure</option>
  </select>
  Reanalysis
  <select id="rean" onchange="javascript:setRean()">
        <option value="ncep_prate_sfc_mon_mean">rainfall</option>
        <option value="ncep_air_2m_mon_mean" selected>temperature</option>
        <option value="">sunshine</option>
        <option value="">pressure</option>
        <option value="wspd_10m_mon_mean">wind speed</option>
  </select>
</div>
<div style="float:left">
  <div id="map_canvas" style="height: 500px; width: 600px;"></div>
 </div>
  <div  style="float:left;">
    <div id="visualization" style="height: 250px; width: 600px;">Vis1</div>
    <div id="visualization2" style="height: 250px; width: 600px;">Vis2</div>
  </div>
</body>
</html>
