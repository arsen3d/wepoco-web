<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
<title>Wepoco: map printing (test)</title>
<script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAAF5oUqxaWkq3HzHxEjwFoMhSqLCR4vqZD7ui-J2nkp63kVD9LDRS75VKmRTRVCob68yw1NBkMXZHKsg" type="text/javascript"></script>
<script type="text/javascript" language="javascript">

var map = null;
var print_spec = null;
var selected_rain = "none";

function print_func() {
    printwin = window.open('print-template.html?'+print_spec);
    printwin.focus();
}

function drawbox( map, a, c ) {
  var b = new GLatLng( a.lat(), c.lng() );
  var d = new GLatLng( c.lat(), a.lng() );
  var points = [a,b,c,d,a]; 
  map.addOverlay( new GPolyline( points ));
}

function define_print( map, a, c ) {
  z = map.getZoom() + 1;
  a_xy = map.fromLatLngToDivPixel(a);
  c_xy = map.fromLatLngToDivPixel(c);
  x = (c_xy.x - a_xy.x) * 2;
  if(x<0) x = -x;
  y = (c_xy.y - a_xy.y) * 2;
  if(y<0) y = -height;
  center_pix = new GPoint((a_xy.x + c_xy.x)/2, (a_xy.y + c_xy.y)/2);
  latlng = map.fromDivPixelToLatLng( center_pix );
  lat = latlng.lat().toFixed(4);
  lng = latlng.lng().toFixed(4);
  print_spec = "z=" + z + "&x=" + x + "&y=" + y + 
    "&lat=" + lat + "&lng=" + lng;
}

function setupMap() {
  map = new GMap2(document.getElementById("map"));
  map.addControl(new GLargeMapControl());
  map.addControl(new GScaleControl());

  var rainlayer = new GTileLayer(
    new GCopyrightCollection("Meteorological data: Wepoco"),4,5);
  var rainlayers = [
                    G_NORMAL_MAP.getTileLayers()[0],
                    //G_HYBRID_MAP.getTileLayers()[0],
                    rainlayer,
                    G_HYBRID_MAP.getTileLayers()[1]
                   ];

  rainlayer.getTileUrl = function(a,b){
    return "http://www.wepoco.com/cgi/zoom2.py?type=mpe&map="+
      selected_rain+"&x="+a.x+"&y="+a.y+"&zoom="+b;
  }
  rainlayer.isPng = function() {return 1;}
  rainlayer.getCopyright = function(a,b) {
    return { prefix: "Meteorological Data:", copyrightTexts:["Wepoco"]};
  }
    
  var custommap = new GMapType(rainlayers, G_SATELLITE_MAP.getProjection(), 
    "Wepoco", {errorMessage:_mMapError});    

  map.addMapType(custommap);
  map.setCenter(new GLatLng(10.0, 16.0), 3, custommap);

  var first_point_set = 0;
  GEvent.addListener(map, "click", 
		   function(marker, point) {
		     var info_div = document.getElementById('info');

		     northEast = map.getBounds().getNorthEast();
                     if (first_point_set == 1) {   
		         drawbox( map, origin, point );
                         define_print( map, origin, point );
                         first_point_set = 0;
                     }else{
                        origin = point;
                        map.clearOverlays();
                        first_point_set = 1;
                        info_div.innerHTML="please click again";
                     }
                     return;
		   }
  );
  return;
}

</script>

<style type="text/css">
.calendar-left {
   visibility: hidden;
   z-index: 2; /* high value as popup calendar will overlap map div */
   position: absolute;
   left: 6px;
   top: 10px;
   width: 650px;
   height: 60px;
   background-color: #FFFFFF;
   cursor: pointer;
}

.map-box {
   position: absolute;
   margin-left: 0px;
   margin-top: 50px;
   width: 630px;
   height: 380px;
   background-color: gray;
}

.map-info {
   position: absolute;
   overflow: auto;
   margin-left: 640px;
   margin-top: 50px;
   color: white;
   background-color: gray;
   width: 200px;
   height: 380px;
   font-family: courier;
   font-size: 12pt;
   color: black;
}


</style>

</head>

<body onload="setupMap()" onunload="GUnload()">

   <div id="menu" class="map-menu">
   <input value="print" type="button" onclick="print_func()" />
   </div>

   <div id="dateselect" class="calendar-left" style="margin:0" >
    <form style="height:100%; padding: 0;" >
    <table border="0" style="width:100%; height:100%; padding: 0"><tr>
    <td>
    <select id="raintype" onChange="checkSelections()">
    <option value="day">24hr rainfall</option>
    <option value="dekad">dekad rainfall</option>
    </select>
    </td>
    <td>
    <script>
    DateInput('raindate', true, 'YYYYMMDD', yesterday);
    SetChangeFunc('raindate', 'checkSelections');
    </script>
    </td>
    </tr>
    </table>
    </form>
   </div>

   <div id="map" class="map-box">
   </div>

   <div id="info" class="map-info">
   </div>

</body>

</html>
