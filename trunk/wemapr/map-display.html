<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Wemapr: map-display</title>
<link rel="stylesheet" type="text/css" href="wemapr.css" />
<script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAAjrevdOcDzRtc2JWIyTrRPBRIm0aEzgz_jKxgCWkUhrc5EfOLVxT32otJCOMcb8tABU03WUPobMjYSg" type="text/javascript"></script>

<script src="ajax.js" type="text/javascript"></script>

<script type="text/javascript" language="javascript">

var map = null;
var map_set = 0;
var basicmap1;
var basicmap0;
var mapChoice;  // an array of choice objects
var configFile = "";
var configIdx = 0;
var chartOpacity = 0.5;

function changeOpacity( opacity ){
  chartOpacity = opacity;
  map.setMapType(G_NORMAL_MAP);
  map.setMapType(basicmap0);
}

function setSearch(){
  configFile = document.getElementById('config').value;
  window.location.search = "?config="+configFile+"&idx="+configIdx;
}

function add_choice( choices, index, name, title, map_url, refzoom, centre, zoom, feeds ) {
  var sel = document.getElementById('map-select');
  var el = document.createElement('option');
  el.innerHTML = name;
  el.setAttribute("value",index);
  sel.appendChild(el);
  choices.push( new choiceObj(name, title, map_url, refzoom, centre, zoom, feeds));
}


function feed_click(cb){
 if(cb.checked){
   map.addOverlay(cb.overlay);
 }else{
   map.removeOverlay(cb.overlay);
 }
}

function add_feed( name, type, url ){
  var rss2kml = "http://pipes.yahoo.com/pipes/pipe.run?_id=QtW0WlhS3BGeRrmxl7okhQ&_render=kml&feed=";
  var div = document.getElementById('feed-menu');
  var el = document.createElement('input');
  el.setAttribute("type","checkbox");
  el.setAttribute("value",name);
  el.setAttribute("onclick","feed_click(this)");
  if(type=="rss"){
    el.overlay =  new GGeoXml(rss2kml + url);
  }else{
    el.overlay = new GGeoXml(url);
  }
  div.appendChild(el);
  var txtn = document.createElement( 'a' );
  txtn.setAttribute("href","#2");
  txtn.innerHTML = name;
  div.appendChild( txtn );
  div.appendChild(document.createElement('br'));
}


function setmap( index ) {
  map_url = mapChoice[index].gmap;
  refzoom = mapChoice[index].refzoom;
  zoom = mapChoice[index].zoom;
  centre = mapChoice[index].centre;
  title =  mapChoice[index].title;
  document.getElementById('maptitle').innerHTML=title;
  info_div = document.getElementById('info');
  info_div.appendChild(document.createTextNode( 
    map_url + " zoom=" + zoom));
  info_div.appendChild(document.createElement('br'));

 if(map_set == 0){
    prefix_el = document.getElementById('prefix1');
    prefix_el.value = map_url;
    map.setMapType(basicmap1);
    map.setZoom(zoom);
    map.panTo(centre);
    map_set = 1
  }else{
    prefix_el = document.getElementById('prefix0');
    prefix_el.value = map_url;
    map.setMapType(basicmap0);
    map.setZoom(zoom);
    map.panTo(centre);
    map_set = 0
  }

  if( mapChoice[index].feeds ){
    // there are feeds associated with this map
    loadFeeds( mapChoice[index].feeds );
  }

}

function choiceObj(name, title, gmap, refzoom, centre, zoom, feeds){
    this.name = name;
    this.title = title;
    this.gmap = gmap;
    this.refzoom = refzoom;
    this.centre = centre;
    this.zoom = zoom;
    this.feeds = feeds;
}

function loadFeeds( feedsList ){
  GDownloadUrl(feedsList, function(data, responseCode) {
     xml=GXml.parse(data);
     feeds = xml.documentElement.getElementsByTagName("feed");
     for(i=0;i<feeds.length;i++){
      name=feeds[i].getElementsByTagName("name")[0].childNodes[0].data;
      type=feeds[i].getElementsByTagName("type")[0].childNodes[0].data;
      url=feeds[i].getElementsByTagName("url")[0].childNodes[0].data;
      add_feed( name, type, url);
     } 
  });
}

function loadxml() {

 var config = document.getElementById('config').value;

 if(config != ""){
 GDownloadUrl(config, function(data, responseCode) {
    mapChoice = new Array();
    xml = GXml.parse(data);
    layers = xml.documentElement.getElementsByTagName("Layer");
    for(i=0;i<layers.length;i++){
      try{
      var name, title, centre, zoom, lon, lat, feeds, refzoom;
      name=layers[i].getElementsByTagName("name")[0].childNodes[0].data;
      try{
      title=layers[i].getElementsByTagName("title")[0].childNodes[0].data;
      }catch(err){
       title=name;
      }
      var gmapNode=layers[i].getElementsByTagName("gmap")[0];
      gmap = gmapNode.childNodes[0].data;
      try{
      refzoom = gmapNode.attributes.getNamedItem("max").value;
      }catch(err){
       refzoom=20;  // i.e. no zoom magnify
      }
      try{
      lon=layers[i].getElementsByTagName("lon")[0].childNodes[0].data;
      lat=layers[i].getElementsByTagName("lat")[0].childNodes[0].data;
      centre = new GLatLng(parseFloat(lat),parseFloat(lon));
      }catch(err){
         alert(err.description);
         centre = new GLatLng(0,0);
      }
      try{
      zoom = parseInt(layers[i].getElementsByTagName("zoom")[0].childNodes[0].data);
      }catch(err){
         zoom=2
      }
      try{
      feeds =  layers[i].getElementsByTagName("feeds")[0].childNodes[0].data;
      }catch(err){
         feeds=null;
      }
      add_choice( mapChoice, i, name, title, gmap, refzoom, centre, zoom, feeds );
    }catch(err){
      alert(err + " with layer=" + i);
    } 
    }
    setmap(configIdx);
 }); //GDownloadUrl
 } //if

}

var missingTiles = new Array;
var emptyImage = new Image;


function isMissingTile(url){
  for(i in missingTiles){
    if(missingTiles[i] == url){
      return 1;
    }
  }
  return 0;
}

// this callback invoked if image tile could not be loaded.
function loadError(){
  if(missingTiles.length > 200){
   missingTiles=missingTiles.slice(0,100);
  }
  missingTiles.unshift(this.src);
}

function testImg( url ){
 if(isMissingTile(url)){
  return emptyImage.src;
 }else{
   // Try to load the image.
   // Failure won't be known until later, but future attempts to load will
   // receive empty tile.
   var im = new Image;
   im.src = url;
   im.onerror = loadError;
   if(im.width != 0){
     return url;
   }
   else{
     var info_div = document.getElementById('info');
     info_div.appendChild(document.createTextNode("missing:" + url));
     info_div.appendChild(document.createElement('br'));
     if(isMissingTile(url)){
       return emptyImage.src;
     }
   }
   return url;
 }
} 

function setup() {

  //window.onbeforeunload=function(){alert("no not again!");};
  chartOpacity = document.getElementById('opacity').value/100.0;
  // Did page open with parameters?
  var searchArr = decodeSearch(window.location);

  for(i in searchArr){
   var ar = searchArr[i].match(/config=(.*)/);
   if(ar){
     configFile = ar[1];
   }
   var idx = searchArr[i].match(/idx=(.*)/);
   if(idx){
     configIdx = idx[1];
   }
  }

  document.getElementById('config').value = configFile;
  loadxml();


  emptyImage.src = "empty.png";
  tabSelect("map");

  map = new GMap2(document.getElementById("map-div"));
    //,{draggableCursor: 'crosshair'});
  map.addControl(new GLargeMapControl());
  map.addControl(new GScaleControl());
  map.enableContinuousZoom();

  var gridlayer0 = new GTileLayer(new GCopyrightCollection(""),1,5);
  var gridlayer1 = new GTileLayer(new GCopyrightCollection(""),1,5);

  var mapLayer = G_NORMAL_MAP.getTileLayers()[0];
  //mapLayer.getOpacity = function() {return 1.0;}
  var basiclayers0 = [ mapLayer, gridlayer0 ];
  var basiclayers1 = [ mapLayer, gridlayer1 ];

  gridlayer1.getTileUrl = function(a,b){
    var prefix = encodeURI(document.getElementById('prefix1').value);
    if(b>refzoom){
      return "http://www.wepoco.com/cgi/wemaprzoom?ref="+refzoom+"&map="+prefix+"&x="+a.x+"&y="+a.y+"&zoom="+b+"&trnsp=0";
    }

    return testImg(prefix+"/"+b+"/"+a.x+"_"+a.y+".png");
  }

  gridlayer0.getTileUrl = function(a,b){
    var prefix = encodeURI(document.getElementById('prefix0').value);
    if(b>refzoom){
      return "http://www.wepoco.com/cgi/wemaprzoom?ref="+refzoom+"&map="+prefix+"&x="+a.x+"&y="+a.y+"&zoom="+b+"&trnsp=0";
    }
    return testImg(prefix+"/"+b+"/"+a.x+"_"+a.y+".png");
  }

  gridlayer1.isPng = function() {return 1;}
  gridlayer1.getOpacity = function() {return chartOpacity;}
  gridlayer1.getCopyright = function(a,b) {
    return { prefix: "", copyrightTexts:[""]};
  }
  gridlayer0.isPng = function() {return 1;}
  gridlayer0.getOpacity = function() {return chartOpacity;}
  gridlayer0.getCopyright = function(a,b) {
    return { prefix: "", copyrightTexts:[""]};
  }
  
  basicmap0 = new GMapType(basiclayers0, G_SATELLITE_MAP.getProjection(), 
    "Wemapr", {errorMessage:"Error"});
  basicmap1 = new GMapType(basiclayers1, G_SATELLITE_MAP.getProjection(),
    "Wemapr", {errorMessage:"Error"});

  map.addMapType(basicmap0);
  map.addMapType(basicmap1);
  map.setCenter(new GLatLng(10.0, 16.0), 3, basicmap0);

  GEvent.addListener(map, "click", 
		   function(marker, point) {
		     var info_div = document.getElementById('info');
                     info_div.appendChild(document.createTextNode(
                        point.lat().toFixed(4) + "N " + 
                        point.lng().toFixed(4) + "E"));
                     info_div.appendChild(document.createElement('br'));
                     return;
		   }
  );
  return;
}
</script>

<!-- N.B. .class-style  #id-style -->
<style type="text/css">

#map-sidebar {
   position: absolute;
   left: 690px;
   margin-top: 0px;
   right: 2px;
   height: 450px;
   border: 1px solid black;
}

#map-menu {
}

#map{
   position: absolute;
   margin-left: 0px;
   margin-top: 0px;
   width: 100%;
   height: 550px;
}


#settings {
   z-index: 1;
   position: absolute;
   padding: 20px;
   width: 350px;
   height: 350px;
   background-color: yellow;
}

#tools {
   z-index: 1;
   position: absolute;
   padding: 20px;
   width: 350px;
   height: 350px;
}

#map-div {
   position: absolute;
   margin-left: 4px;
   margin-top: 0px;
   width: 680px;
   height: 450px;
   background-color: gray;
}


#info {
   position: absolute;
   overflow: auto;
   margin-left: 10px;
   margin-top: 120px;
   background-color: white;
   width: 305px;
   height: 200px;
   font-family: courier;
   font-size: 10pt;
   color: black;
}


</style>

<script>

var tabbed = new Array( "map", "settings", "tools" );

function _tabClear() {
    var panel,tab;
    for(i in tabbed){
      try{
        panel=document.getElementById(tabbed[i]);
        panel.style.zIndex = -2;
        panel.style.backgroundColor="#ffffaa";
        tab=document.getElementById(tabbed[i]+"-tab");
        tab.style.backgroundColor="#ffffaa";
        tab.style.borderBottom="1px solid black";
      }catch(err){}
    }
}

function tabSelect(name) {
   _tabClear();
   panel=document.getElementById(name);
   panel.style.zIndex=2;
   panel.style.backgroundColor="#ffff00";
   var mytab=document.getElementById(name+"-tab");
   mytab.style.backgroundColor="#ffff00";
   mytab.style.borderBottom="1px solid #ffff00";
}

function tabClick(name) {
  var panel=document.getElementById(name);

  if(panel.style.zIndex < 0){
    _tabClear();
    panel.style.zIndex = 2;
    panel.style.backgroundColor="#ffff00";
    var mytab=document.getElementById(name+"-tab");
    mytab.style.backgroundColor="#ffff00";
    mytab.style.borderBottom="1px solid #ffff00";
  }
}

</script>

</head>
<body onload="setup()" onunload="GUnload()">

<div id="buttonbar" style="position:absolute;" >
  <div class="line" ></div>
  <div id="map-tab" onclick="tabClick('map')" class="tab">&nbsp;map&nbsp;</div>
  <div id="settings-tab" onclick="tabClick('settings')" class="tab">&nbsp;settings&nbsp;</div>
  <div id="tools-tab" onclick="tabClick('tools')" class="tab">&nbsp;tools&nbsp;</div>
</div>

<div style="position:absolute;background:pink;width:100%;height:1px;left:0px;top:20px">



   <div id="map">
      <h2 style="text-align:center" id="maptitle">Wemapr</h2>
      <div id="map-div"></div>
   <div id="map-sidebar">
     <div id="map-menu"><select id="map-select" onchange="setmap(this.value)" name="map-select">
<!-- <option value="null">---</option> -->
</select>
</div>
     <div id="feed-menu"></div>
   </div>   


   </div>
   <div id="settings" >
       <div>
       <form>
       <input type="hidden" id="base" value="" />
       <input type="hidden" id="prefix1" value="" />
       <input type="hidden" id="prefix0" value="" />
       <table>
       <tbody>
       <tr>
       <td>file</td>
       <td>
         <input id="config" />
       </td>
       <td>
         <input type="button" value="load" onclick="setSearch()"/>
       </td>
       </tr>
       <tr>
         <td>opacity</td>
         <td><select id="opacity"onchange="changeOpacity(this.value/100.0)">
         <option value="25">25%</option>
         <option selected value="50">50%</option>
         <option value="75">75%</option>
         </select></td>
       </tr>
       </tbody>
       </table>
       </form>
       </div>
       <div id="info"></div>
    </div> 
    <div id="tools" >
      <p><a href="map-define.html">Import charts</a></p>
    </div>
   </div>
</body>
</html>
