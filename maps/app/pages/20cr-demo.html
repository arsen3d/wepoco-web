<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>20cr-demo</title>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.5/dijit/themes/tundra/tundra.css" />

<!--[if IE]>
  <script src="http://danvk.org/dygraphs/excanvas.js"></script>
<![endif]-->
<script src="http://danvk.org/dygraphs/dygraph-combined.js"></script> 

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="20cr.js"></script>
<script type="text/javascript">
</script>
<script type="text/javascript">
	djConfig = { parseOnLoad:true, isDebug:false };
</script>
<script src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
  google.load('dojo', '1.5');  
  google.load('visualization', '1', {packages:['table']});
</script>
<script type="text/javascript">
  dojo.require('dojo.parser');
  dojo.require('dojo.io.script');
  dojo.require('dojo.DeferredList');
  dojo.require('dijit.form.Form');
  dojo.require('dijit.form.RadioButton');
  dojo.require('dijit.form.Button');
  dojo.require('dijit.form.Select');
  dojo.require('dijit.form.ValidationTextBox');
  dojo.require('dijit.form.TextBox');
  dojo.require('dijit.form.NumberTextBox');
  dojo.require('dijit.form.FilteringSelect');

  dojo.addOnLoad(setup);

  var map;
  //var graphData = [];
  var graphhi, graphlo;  // The Dygraphs

  function initialise() {
    outDiv = dojo.byId("out_div");
    var myOptions = {
      zoom: 2,
      center: new google.maps.LatLng(0, 0),
      mapTypeControl: false, 
      mapTypeId: google.maps.MapTypeId.TERRAIN,
      streetViewControl: false
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    google.maps.event.addListener(map, 'click', function(event) {
      fetchDataByPosn(event.latLng);
    }); 

   var wxMapOptions = {
    map: map,
    name: "Wx",
    minZoom: 3,
    maxZoom: 10
   }
   var wxstyle = [
    {featureType:"all",stylers:[{hue: 000000},{saturation: -10},{lightness: 30}]},
    {featureType:"road",elementType:"all",stylers:[{visibility:"off"}]},
    {featureType:"administrative",elementType:"labels",stylers:[{visibility:"on"}]}];
   var wxMapType =  new google.maps.StyledMapType(wxstyle,wxMapOptions);
   map.mapTypes.set('wx', wxMapType);
   map.setMapTypeId('wx');

   return 0;
 }

function rainGraph(data){
  //var settings = {colors:['gray','blue'],customBars:true,errorBars:true};
  //settings.labels=['date','reanalysis','satellite'];
  var settings = {colors:['gray']};
  var graphData = data.data;

  for(var i in graphData){
     var d = new Date(graphData[i][0]);
     graphData[i][0] = d;
  }
 graphhi = new Dygraph(document.getElementById("graphdivhi"), graphData, settings);  
}

function tempGraph(data){
  //var settings = {colors:['gray','blue'],customBars:true,errorBars:true};
  //settings.labels=['date','reanalysis','satellite'];
  var settings = {colors:['gray']};
  var graphData = data.data;

  for(var i in graphData){
     var d = new Date(graphData[i][0]);
     graphData[i][0] = d;
  }
 graphlo = new Dygraph(document.getElementById("graphdivlo"), graphData, settings);  
}

function plotData(arr){
  // first need to merge the arrays
  var combined = new Array();
  
  // 'Temperature':{axis:{yAxisLabelFormatter:function(x){return x}}}

  var settings = {labels:["Date","Rain","Temperature"],
   'Temperature':{axis:{}}
  };
  for(var i in arr[0]){
    var d = new Date(arr[0][i][0]);
    combined.push([d,arr[0][i][1],arr[1][i][1]]);
  }
 graphhi = new Dygraph(document.getElementById("graphdivhi"), combined, settings);
}

function loadrain(data){
  rainGraph(data);
}

function loadtemp(data){
  tempGraph(data);
}

function lfn(xy){
  //alert(dojo.toJson(point));
  series20cr({cell:xy,quantity:'prate_mon_mean',load:loadrain,error:efn});  
  series20cr({cell:xy,quantity:'air_2m_mon_mean',load:loadtemp,error:efn});  
}

function lfnn(xy){
  var rain = {cell:xy,quantity:'prate_mon_mean'};
  var fetch_rain =  dojo.io.script.get({
        url:"http://saunby.net/cgi-bin/py/series20cr.py", 
        content:{x:rain.cell.x,y:rain.cell.y,q:rain.quantity},
        callbackParamName: "callback", handleAs:"json"});
  var temp = {cell:xy,quantity:'air_2m_mon_mean'};
  var fetch_temp =  dojo.io.script.get({
        url:"http://saunby.net/cgi-bin/py/series20cr.py", 
        content:{x:temp.cell.x,y:temp.cell.y,q:temp.quantity},
        callbackParamName: "callback", handleAs:"json"});

  var defs = new dojo.DeferredList([fetch_rain,fetch_temp]);

  // defs.then() sets the function called when all calls in the deferred list have
  // returned.  See http://dojotoolkit.org/documentation/tutorials/1.6/deferreds/
  defs.then(function(res){
    plotData([res[0][1].data,res[1][1].data]);
  });
}

function efn(msg){
  alert(msg);
}

 // Map click listener
 function fetchDataByPosn(latlng) {
   mylatlng = latlng;
   //alert(mylatlng);
   coords20cr({latlng:mylatlng,load:lfnn,error:efn});
   return 0;
 }

 function setup() {
  initialise();
  return 0;
 }
</script>
</head>
<body class="tundra" style="background-color:white;margin:0px;padding:0px;">
<h1>20cr-demo</h1>
<div id="graphdivhi" style="width:400px;height:220px" ></div>
<!--<div id="graphdivlo" style="width:400px;height:220px" ></div>-->
<div id="map_canvas" style="width:600px;height:460px"></div>
</body>
</html>
