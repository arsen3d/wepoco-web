<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>RFE map</title>
<link rel="stylesheet" href="css/blueprint/screen.css" type="text/css" media="screen, projection">
<link rel="stylesheet" href="css/blueprint/print.css" type="text/css" media="print">
<!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
<link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection">
<link rel="stylesheet" href="style.css" type="text/css" />
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.5/dijit/themes/tundra/tundra.css" />
<style type="text/css"><!--
.tinyHeaderClass {font-size:50%;}
.formQuestion {
	background-color:#d0e3f5;
	padding:0.3em;
	font-weight:900;
	font-family:Verdana, Arial, sans-serif;
	font-size:0.8em;
	color:#5a5a5a;
}
.formAnswer {
	background-color:#f5eede;
	padding:0.3em;
	margin-bottom:1em;
	width: 100%;
}
.pageSubContentTitle {
		color:#8e8e8e;
		font-size:1em;
		font-family:Verdana, Arial, sans-serif;
		margin-bottom:0.75em;
}
body .short {
	width: 3em;
}
body .medium {
	width: 10em;
}
body .long {
	width: 20em;
}
.firstLabel {
	display: inline-block;
	display: -moz-inline-box;
	width: 10em;
	min-width: 10em;
}
.secondLabel {
	width: auto;
	margin-left: 5em;
	margin-right: 1em;
}
fieldset label {
	margin-right: 1em;
}
.noticeMessage {
	display: block;
	float: right;
	font-weight: normal;
	font-family:Arial, Verdana, sans-serif;
	color:#663;
	font-size:0.9em;
}

--></style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
</script>
<script type="text/javascript">
	djConfig = { parseOnLoad:true, isDebug:false };
</script>
<script src="http://danvk.org/dygraphs/dygraph-combined.js"></script> 
<script src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
  google.load('dojo', '1.5');  
  google.load('visualization', '1', {packages:['table']});
</script>
<script src="proj4js-combined.js"></script> 
<script src="settings.js"></script> 
<script type="text/javascript">
  dojo.require('dojo.parser');
  dojo.require('dojo.io.script');
  dojo.require("dijit.form.Form");
  dojo.require("dijit.form.RadioButton");
  dojo.require("dijit.form.ValidationTextBox");
  dojo.require("dijit.form.NumberTextBox");
  dojo.require("dijit.form.FilteringSelect");

  dojo.addOnLoad(setup);

  Proj4js.reportError = function(msg) {alert(msg);}
  
  // Brand colours
  var bcols = {green:"#CCFF33",blue:"#031F73",cyan:"#00ADD0", olive:"#878800"};

  var outDiv;
  var map;
  var circle;
  var clock;
  var dispStyle = 0;  // Default to 12 hour clock style.
  var sites = [];
  var selectedSite;  // look like this - {latlng:latlng, id:id, lb:lb, min:minzoom}
  var siteForecast = [];
  var siteForecastDays = [];
  var forecastTimes = [];
  var markers = [];
  var typeMap = [];
  var graphData = [];
  var srcProj;
  var dstProj;

  function initialise() {
Proj4js.defs["MYPROJ"] = "+proj=aea +lat_1=-19 +lat_2=21 +lat_0=1 +lon_0=20 +x_0=0 +y_0=0 +units=m +ellps=clrk66 +no_defs";
Proj4js.defs["AFRRFE"] = "+proj=aea +lat_1=-19 +lat_2=21 +lat_0=1 +lon_0=20 +x_0=0 +y_0=0 +units=m +ellps=clrk66 +to_meter=8000 +no_defs";
    Proj4js.defs["LONGLAT"] = "+proj=longlat +ellps=intl +towgs84=-637,-549,-203,0,0,0,0, +no_defs";
    srcProj = new Proj4js.Proj('LONGLAT');    //source coordinates will be in Longitude/Latitude
    dstProj = new Proj4js.Proj('MYPROJ');     //destination coordinates
    rfeProj = new Proj4js.Proj('AFRRFE');     //destination coordinates

    outDiv = dojo.byId("out_div");
    var myOptions = {
      zoom: 7,
      center: new google.maps.LatLng(settings.centre.lat, settings.centre.lon),
      mapTypeControl: false, 
      mapTypeId: google.maps.MapTypeId.TERRAIN,
      streetViewControl: false
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    google.maps.event.addListener(map, 'zoom_changed', function() {
      showAllSites();
     });
    google.maps.event.addListener(map, 'click', function(event) {
      fetchDataByPosn(event.latLng);
    }); 

   var wxMapOptions = {
    map: map,
    name: "Wx",
    minZoom: 5,
    maxZoom: 10
   }

  var wxMapType =  new google.maps.StyledMapType(wxstyle,wxMapOptions);
  
  map.mapTypes.set('wx', wxMapType);
  map.setMapTypeId('wx');

  }


 function drawCircle(latlng){
   if(circle){circle.setMap(null)};
   circle = new google.maps.Circle({center:latlng,radius:10000,
		strokeColor:bcols.cyan,strokeOpacity:1,strokeWeight:2,
                fillColor:bcols.cyan,fillOpacity:0.5});
   circle.setMap(map);
   //google.maps.event.addListener(circle, 'click', function(event) {
   //   do_something(event.latLng);
   // }); 

 }

function RFExy(p){
     Proj4js.transform(srcProj, dstProj, p);
     //p.x += 576;
     //p.y = -p.y + 576;
     return p;
}

function RFEll(p){
     //p.x += 576;
     //p.y = -p.y + 576;
     Proj4js.transform(dstProj, srcProj, p);
     return p;
}

function ARFEll(p){
     p.x -= (4237357/8000);
     p.y = (4272328/8000) - p.y;
     Proj4js.transform(rfeProj, srcProj, p);
     return p;
}

function ARFExy(p){
     Proj4js.transform(srcProj, rfeProj, p);
     p.x += (4237357/8000);
     p.y = (4272328/8000) - p.y;
     return p;
}


function plotGraph(retdata){

  f = dojo.byId('rainForm');
  console.dir(f['period']);

  if(1){
    data = retdata.dekadrain;
    settings =  {labels:['date','dekad rain'],customBars:true,errorBars:true};
  }
  else
  {
    data = retdata.monthrain;
    settings =  {labels:['date','month rain']};
  }

  for(var i in data){
    data[i][0] = new Date(data[i][0]);
  } 
  var g = new Dygraph(document.getElementById("graphdiv"), data,settings);
  
  // Or keep graph and update using -
  //g.updateOptions( { 'file': graphData } );

  //dojo.byId("info").innerHTML = retdata.message;
}

// Map click listener

function fetchDataByPosn(latlng){
     mylatlng = latlng;
     drawCircle(latlng);
     dijit.byId('locationForm').set('value',{lat:latlng.lat(),lng:latlng.lng()});
     var p;
     var text = "";
     /*
     p = ARFEll({x:0,y:0});
     text += "<br> hdr top left lng:" + p.x + " lat:" + p.y;
     p = ARFEll({x:994,y:1089});
     text += "<br> hdr top left lng:" + p.x + " lat:" + p.y;
     dojo.byId("info").innerHTML = text;
     */
     p = ARFExy({y:latlng.lat(),x:latlng.lng()});
     /*
     var xhrArgs = {
        url: "http://map.wepoco.com/arfe",
        content: {x:p.x,y:p.y,year:2010,dekad:1,count:36},
        handleAs: "json",
        load: function(data) {
                    plotGraph( data );
                },
                error: function(error) {
                    alert("Error " + error);
                }
 
        };
     var deferred = dojo.xhrGet(xhrArgs);
     */
     // See http://docs.dojocampus.org/dojo/io/script
     var jsonpArgs = {
        url: "http://map.wepoco.com/arfe",
        content: {x:p.x,y:p.y,year:2010,dekad:1,count:36},  
        callbackParamName: "callback",
        load: function(data){ plotGraph( data );},
        error: function(error) { alert("Error " + error);}
        };
     dojo.io.script.get(jsonpArgs);
  }


function clearMap() {
   for (var m=0; m<markers.length; m++){
        markers[m].setMap(null);
   }
   markers = [];
}

function setup() {
   initialise();
}

</script>
</head>
<body class="tundra" style="background-color:white;margin:0px;padding:0px;">
<div class="container"> 
  <div style="background-color:black">
    <!--
    <img src="met_logo.gif" alt="Met Office logo" title="Met Office alpha"/><b>alpha</b>
    -->
    <h1>RFE map</h1>
  </div>


<div class="span-12">
  <div id="map_canvas" style="width:460px;height:460px"></div>
</div>
<div  class="span-12 last" style="background-color:white">
<div>
<form  dojoType="dijit.form.Form" id="locationForm">
lat<input type="text" name="lat" class="short" dojoType="dijit.form.NumberTextBox" readonly />N
&nbsp;
lng<input type="text" name="lng" class="short" dojoType="dijit.form.NumberTextBox" readonly />E
<input type="text" name="alt" class="medium" dojoType="dijit.form.ValidationTextBox" readonly />
</form>
<p>Rainfall estimate (mm)</p>
</div>
<div id="graphdiv" style="width:455px;height:420px" ></div>
<form  dojoType="dijit.form.Form" id="rainForm">
    <input type="radio"  dojoType="dijit.form.RadioButton" name="period" id="radioDay" value="day" />
    <label for="radioDay">
        Day
    </label>
    <input type="radio" dojoType="dijit.form.RadioButton" name="period" id="radioDekad"
    value="dekad" checked />
    <label for="radioDekad">
        Dekad
    </label>
    <input type="radio" dojoType="dijit.form.RadioButton" name="period" id="radioMonth"
    value="month" />
    <label for="radioMonth">
        Month
    </label>
</form>
</div>
<div  class="span-24 last" style="background-color:white">
<span id="info">Hello world</span>
</div>
</div> <!-- container -->
</body>
</html>
